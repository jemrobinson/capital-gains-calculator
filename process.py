#! /usr/bin/env python
"""Process CSV files generated by Portfolio Performance using: All transactions > Export"""
# Standard library imports
from argparse import ArgumentParser
import logging

# Third party imports
from numpy import datetime64
import pandas as pd

# Local imports
from capital_gains_calculator import read_xml, Security


def load_csv(file_name):
    # Read all CSV entries with a valid symbol and security
    df_transactions = pd.read_csv(file_name)
    df_transactions.dropna(subset=["Symbol", "Security"], inplace=True)

    # Set datatypes
    df_transactions["Date"] = pd.to_datetime(df_transactions["Date"])
    df_transactions["Shares"] = df_transactions["Shares"].str.replace(",", "")
    df_transactions["Amount"] = df_transactions["Amount"].str.replace(",", "")
    logging.debug(f"Processing {df_transactions.shape[0]} transactions...")

    return df_transactions


def load_xml(file_name):
    # Read all XML entries with a valid symbol and security
    df_transactions = read_xml(file_name)
    df_transactions.dropna(subset=["Symbol", "Security"], inplace=True)

    # Set datatypes
    df_transactions["Date"] = pd.to_datetime(df_transactions["Date"])
    logging.debug(f"Processing {df_transactions.shape[0]} transactions...")

    return df_transactions


def process_data(df_input, account_names, start_date, end_date):
    # Restrict to specified accounts
    if account_names:
        logging.debug(f"Restricting to only the following accounts: {account_names}")
        df_input = df_input.loc[(df_input["Cash Account"].isin(account_names))]
    logging.debug(f"Identified {df_input.shape[0]} transactions...")
    df_securities = df_input[["ISIN", "Symbol", "Security"]].drop_duplicates()
    logging.debug(f"Identified {df_securities.shape[0]} securities...")

    logging.info(
        f"Looking for capital gains during UK tax year {start_date.astype(object).year}-{end_date.astype(object).year}..."
    )
    for _, transaction in sorted(
        df_securities.iterrows(), key=lambda r: r[1][2].lower()
    ):
        security = Security(symbol=transaction[1], name=transaction[2])
        security.add_transactions(df_input.loc[(df_input["Security"] == security.name)])
        if any([start_date <= d[0].date <= end_date for d in security.disposals]):
            security.report()


if __name__ == "__main__":
    # Parse command line arguments
    parser = ArgumentParser()
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument("-c", "--csv", type=str, help="CSV file to process")
    group.add_argument("-x", "--xml", type=str, help="XML file to process")
    parser.add_argument(
        "-t",
        "--tax-year",
        metavar="N",
        type=str,
        help="tax year to consider [either YYYY-YY or YYYY-YYYY]",
    )
    parser.add_argument(
        "-n", "--account-names", type=str, nargs="+", help="accounts to consider"
    )
    parser.add_argument(
        "-v", "--verbosity", action="count", default=0, help="increase output verbosity"
    )
    args = parser.parse_args()

    # Set up logging
    log_levels = [logging.INFO, logging.DEBUG]
    logging.basicConfig(
        format=r"%(asctime)s %(levelname)8s: %(message)s",
        datefmt=r"%Y-%m-%d %H:%M:%S",
        level=log_levels[min(len(log_levels) - 1, args.verbosity)],
    )

    # Set start and end dates
    try:
        start_date = datetime64(f"{args.tax_year.split('-')[0]}-04-06")
        end_date = datetime64(f"{int(args.tax_year.split('-')[0]) + 1}-04-05")
    except AttributeError:
        raise ValueError(
            "Could not interpret '%s' as a UK tax year!"
            % (args.tax_year if args.tax_year else "")
        ) from None
    logging.debug(f"Set start date ({start_date}) and end date ({end_date})")

    if args.csv:
        df_transactions = load_csv(args.csv)

    elif args.xml:
        df_transactions = load_xml(args.xml)

    process_data(df_transactions, args.account_names, start_date, end_date)
